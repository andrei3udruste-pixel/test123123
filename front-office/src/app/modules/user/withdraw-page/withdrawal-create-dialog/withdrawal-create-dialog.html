<h2 mat-dialog-title>{{ 'withdrawal.add.title' | translate }}</h2>

<mat-dialog-content class="min-w-[400px]">
  @if (wallet) {
    <div class="flex flex-col gap-2 mb-4 p-3 bg-gray-800/50 rounded-lg">
      <div class="flex justify-between items-center">
        <span class="text-sm opacity-70">{{ 'wallet.balance' | translate }}</span>
        <span class="text-lg font-semibold">{{ wallet.balance | number:'1.2-2' }} {{ wallet.currency }}</span>
      </div>
    </div>
  }

  <form [formGroup]="form" class="flex flex-col gap-4">

    <mat-form-field appearance="outline" class="w-full">
      <mat-label>{{ 'withdrawal.amount' | translate }} (Stakes)</mat-label>
      <input matInput type="number" formControlName="amount" min="1" step="0.01" />
      @if (form.get('amount')?.touched && form.get('amount')?.hasError('required')) {
        <mat-error>{{ 'error.form.required' | translate }}</mat-error>
      }
      @if (form.get('amount')?.touched && form.get('amount')?.hasError('min')) {
        <mat-error>{{ 'withdrawal.amount' | translate }} must be greater than 0</mat-error>
      }
      @if (form.get('amount')?.touched && wallet && form.get('amount')?.value > wallet.balance) {
        <mat-error>{{ 'withdrawal.insufficientBalance' | translate }}</mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline" class="w-full">
      <mat-label>{{ 'withdrawal.currency' | translate }}</mat-label>
      <mat-select formControlName="currencyCode">
        @for (currency of currencies; track currency.code) {
          <mat-option [value]="currency.code">{{ currency.code }} - {{ currency.name }}</mat-option>
        }
      </mat-select>
      @if (form.get('currencyCode')?.touched && form.get('currencyCode')?.hasError('required')) {
        <mat-error>{{ 'error.form.required' | translate }}</mat-error>
      }
    </mat-form-field>

    @if (convertedAmount !== undefined && selectedCurrency) {
      <div class="bg-blue-900/30 border border-blue-500/50 rounded-lg p-4">
        <p class="text-sm text-blue-300">{{ 'withdrawal.conversionPreview' | translate }}</p>
        <p class="text-xl font-bold text-blue-100">
          {{ form.get('amount')?.value | number:'1.2-2' }} Stakes = {{ convertedAmount | number:'1.2-2' }} {{ selectedCurrency.code }}
        </p>
      </div>
    }

    <mat-form-field appearance="outline" class="w-full">
      <mat-label>{{ 'withdrawal.payoutMethod' | translate }}</mat-label>
      <mat-select formControlName="payoutMethod">
        <mat-option value="IBAN">IBAN</mat-option>
        <mat-option value="REVOLUT">Revolut</mat-option>
        <mat-option value="PAYPAL">PayPal</mat-option>
      </mat-select>
      @if (form.get('payoutMethod')?.touched && form.get('payoutMethod')?.hasError('required')) {
        <mat-error>{{ 'error.form.required' | translate }}</mat-error>
      }
    </mat-form-field>

    <mat-form-field appearance="outline" class="w-full">
      <mat-label>{{ 'withdrawal.payoutDetails' | translate }}</mat-label>
      <input matInput type="text" formControlName="payoutDetails" [placeholder]="'withdrawal.payoutDetails.placeholder' | translate" />
      @if (form.get('payoutDetails')?.touched && form.get('payoutDetails')?.hasError('required')) {
        <mat-error>{{ 'error.form.required' | translate }}</mat-error>
      }
    </mat-form-field>

  </form>
</mat-dialog-content>

<mat-dialog-actions align="end">
  <button mat-button (click)="onCancel()" [disabled]="isSubmitting">
    {{ 'actions.close' | translate }}
  </button>
  <button
    mat-flat-button
    color="primary"
    (click)="onSubmit()"
    [disabled]="form.invalid || !isAmountValid() || isSubmitting">
    @if (isSubmitting) {
      <mat-spinner diameter="20"></mat-spinner>
    } @else {
      {{ 'withdrawal.submit' | translate }}
    }
  </button>
</mat-dialog-actions>
